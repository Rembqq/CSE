name: lab4

on:
  push:
    paths:
      - 'lab4/**'
  pull_request:
    paths:
      - 'lab4/**'

jobs:

  build:
    runs-on: ubuntu-latest

    steps:
    - name: Cloning lab4
      uses: actions/checkout@v2

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v1

    - name: Build Docker
      run: |
       cd ./lab4/
       docker build -f Dockerfile -t lab-4:v1 .

    - name: Docker compose
      run: |
       cd ./lab4/
       docker-compose up

    - name: Unit test
      run: |
        cd ./lab4/cmd/lb/
        go test

    - name: Docker compose integration
      run: |
       cd ./lab4/
       docker-compose -f docker-compose.yaml -f docker-compose.test.yaml up --exit-code-from test

    - name: Integration test
      run: |
        cd ./lab4/integration/
        go test
